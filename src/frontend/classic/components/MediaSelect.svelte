<script lang="ts">
    import {
        ComboBox,
        Button,
        Search,
        ContextMenu,
        ContextMenuDivider,
        ContextMenuOption,
        Loading,
    } from 'carbon-components-svelte';

    import { UpdateNow } from 'carbon-icons-svelte';
    import Fuse from 'fuse.js';

    import { fade } from 'svelte/transition';

    import Media from './Media.svelte';
    import Tracker from './Tracker.svelte';

    import { selectedPlugin, selectedMedia, selectedItem } from '../Stores';

    import VirtualList from '@sveltejs/svelte-virtual-list';

    import type { IMediaContainer } from '../../../engine/providers/MediaPlugin';
    import type { IMediaInfoTracker } from '../../../engine/trackers/IMediaInfoTracker';

    import type { ComboBoxItem } from 'carbon-components-svelte/types/ComboBox/ComboBox.svelte';

    let medias: IMediaContainer[] = [];
    let filteredmedias: IMediaContainer[] = [];
    let fuse = new Fuse(medias, {
        keys: ['Title'],
        findAllMatches: true,
        ignoreLocation: true,
        minMatchCharLength: 1,
        fieldNormWeight: 0
    });
    
    let loadPlugin:Promise<void>;
    let mediasdiv: HTMLElement;

    // Todo : implement favorites
    let pluginsFavorites = ['sheep-scanlations'];

    let pluginsCombo: Array<ComboBoxItem>;
    let orderedPlugins : IMediaContainer[] = [];

    orderedPlugins = HakuNeko.PluginController.WebsitePlugins.sort((a, b) => {
        return (
            // sort by favorite
            (pluginsFavorites.includes(a.Identifier) ? 0 : 1) -
                (pluginsFavorites.includes(b.Identifier) ? 0 : 1) ||
            //sort by string
            a.Title.localeCompare(b.Title)
        );
    });
    pluginsCombo = orderedPlugins.map((plugin) => {
        return {
            id: plugin.Identifier,
            text: plugin.Title,
        };
    });


    function pluginsComboText (item:ComboBoxItem):string {
        return pluginsFavorites.includes(item.id) ? '⭐' + item.text : item.text;
    }

    let pluginDropdownSelected:string;
    let currentPlugin:string;

    selectedPlugin.subscribe(value => {
        if (!value || value?.Identifier === currentPlugin) return;
        currentPlugin = pluginDropdownSelected = value.Identifier;
        medias = (value?.Entries as IMediaContainer[]) ?? [];
        fuse = new Fuse(medias, {
            keys: ['Title'],
            findAllMatches: true,
            ignoreLocation: true,
            minMatchCharLength: 1,
            fieldNormWeight: 0
        });
        $selectedMedia=undefined;
        $selectedItem=undefined;
    });

    let mediaNameFilter = '';
    $: filteredmedias =
        mediaNameFilter === ''
            ? medias
            : fuse.search(mediaNameFilter).map((item) => item.item);

    let isTrackerModalOpen = false;
    let selectedTracker: IMediaInfoTracker;

    function shouldFilterPlugin(item: any, value: string) {
        if (!value) return true;
        return item.text.toLowerCase().includes(value.toLowerCase());
    }

    async function onUpdateMediaEntriesClick() {
        loadPlugin = $selectedPlugin?.Update();
        await loadPlugin;
        medias = ($selectedPlugin?.Entries as IMediaContainer[]) ?? [];
    }
</script>


{#if isTrackerModalOpen}
    <div>
        <Tracker
            {isTrackerModalOpen}
            media={$selectedMedia}
            tracker={selectedTracker}
            on:close={() => (isTrackerModalOpen = false)}
        />
    </div>
{/if}
<ContextMenu target={mediasdiv}>
    <ContextMenuOption indented labelText="Browse Chapters" shortcutText="⌘B" />
    <ContextMenuOption indented labelText="Add to Bookmarks" shortcutText="⌘F" />
    <ContextMenuDivider />
    <ContextMenuOption indented labelText="Trackers">
        {#each window.HakuNeko.PluginController.InfoTrackers as tracker}
            <ContextMenuOption labelText="{tracker.Title}" on:click={() => {selectedTracker=tracker; isTrackerModalOpen=true;}} />
        {/each}
    </ContextMenuOption>
    <ContextMenuDivider />
    <ContextMenuOption indented labelText="Bookmark" shortcutText="⌘B" />
</ContextMenu>
<div id="Media" transition:fade>
    <div id="MediaTitle">
        <h5 class="separator">Media List (Manga, Anime etc..)</h5>
    </div>
    <div id="Plugin">
        <div class="inline-wide">
            <ComboBox
                placeholder="Select a Plugin"
                bind:selectedId={pluginDropdownSelected}
                on:select={(event)=>$selectedPlugin=orderedPlugins.find((plugin) => (plugin.Identifier===event.detail.selectedId))}
                size="sm"
                items={pluginsCombo}
                shouldFilterItem={shouldFilterPlugin}
                itemToString={pluginsComboText}
            />
        </div>

        <div class="inline">
            <Button
                icon={UpdateNow}
                size="small"
                tooltipPosition="bottom"
                tooltipAlignment="center"
                iconDescription="Update"
                on:click={onUpdateMediaEntriesClick}
            />
        </div>
    </div>

    <div id="MediaFilter">
        <Search size="sm" bind:value={mediaNameFilter} />
    </div>
    <div id="MediaList" class="list" bind:this={mediasdiv}>
        {#await loadPlugin}
            <div class="loading center">
                <div><Loading withOverlay={false} /></div>
                <div>... medias</div>
            </div>
        {:then}
            <VirtualList items={filteredmedias} let:item>
                <Media
                    media={item}
                    selected={selectedMedia === item}
                    on:select={(e) => {
                        $selectedMedia = e.detail;
                    }}
                />
            </VirtualList>
        {:catch}
            Error loading medias
        {/await}
    </div>
    <div id="MediaCount">
        Medias : {filteredmedias.length}/{medias.length}
    </div>
</div>

<style>
    #Media {
        min-height: 0;
        height: 100%;
        display: grid;
        grid-template-rows: 2em 2em 2em 1fr 2em;
        gap: 0.3em 0.3em;
        grid-template-areas:
            'MediaTitle'
            'Plugin'
            'MediaFilter'
            'MediaList'
            'MediaCount';
        grid-area: Media;
    }
    #Plugin {
        grid-area: Plugin;
        display: table;
    }
    #MediaFilter {
        grid-area: MediaFilter;
        display: table;
    }
    #MediaList {
        grid-area: MediaList;
        background-color: var(--cds-field-01);
        overflow: hidden;
        user-select: none;
    }
    #MediaList .loading {
        width:100%;
        height:100%;
    }
    #MediaCount {
        grid-area: MediaCount;
        display: table;
        margin: 0.25em;
    }
    :global(#Plugin-combo) {
        display: table-cell;
        width: 100%;
    }
    .separator {
        border-bottom: 1px groove var(--cds-button-separator);
    }

    .inline {
        width: fit-content;
    }
    .inline-wide {
        display: table-cell;
        width: 100%;
    }
</style>
